{% load static %}
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Tarot</title>
    <style>
        @font-face {
            font-family: 'W95FA';
            src: url('{% static "pixel-tarot/assets/fonts/W95FA.otf" %}') format('opentype');
        }
        
        #game-container {
            margin-top: -70px;
        }
    </style>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@100;400;700&family=Quicksand:wght@300..700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'pixel-tarot/css/style.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <script>
        // Game configuration
        const config = {
            type: Phaser.AUTO,
            width: 600,
            height: 800,
            parent: 'game',
            scene: {
                preload: preload,
                create: create
            },
            audio: {
                disableWebAudio: false,
                noAudio: false
            },
            dom: {
                createContainer: true
            },
            plugins: {
                scene: [{
                    key: 'PhaserDOM',
                    plugin: Phaser.Plugins.ScenePlugin,
                    mapping: 'dom'
                }]
            }
        };

        // Start game
        let gameInstance = null;
        window.onload = () => gameInstance = new Phaser.Game(config);

        // Responsive settings
        function getGameDimensions() {
            const width = 600;
            const height = 800;
            const windowRatio = window.innerWidth / window.innerHeight;
            const gameRatio = width / height;
            
            if (windowRatio < gameRatio) {
                const scale = window.innerWidth / width;
                return { width: width * scale, height: height * scale, scale };
            } else {
                const scale = window.innerHeight / height;
                return { width: width * scale, height: height * scale, scale };
            }
        }

        function updateGameSize() {
            const gameDim = getGameDimensions();
            const gameElement = document.getElementById('game');
            gameElement.style.width = gameDim.width + 'px';
            gameElement.style.height = gameDim.height + 'px';
            return gameDim.scale;
        }

        window.addEventListener('load', updateGameSize);
        window.addEventListener('resize', updateGameSize);

        // Load assets
        function preload() {
            // Background and UI
            this.load.image('background', '{% static "pixel-tarot/assets/background.png" %}');
            this.load.image('background-2', '{% static "pixel-tarot/assets/background-2.png" %}');
            this.load.image('refresh', '{% static "pixel-tarot/assets/refresh.png" %}');
            this.load.image('mainmenu', '{% static "pixel-tarot/assets/mainmenu.png" %}');
            
            // Cards
            this.load.image('card_back', '{% static "pixel-tarot/assets/tarot__back.png" %}');
            {% for card in cards %}
            this.load.image('{{ card.name }}', '{% static card.front_image_url %}');
            {% endfor %}
            
            // Sounds
            this.load.audio('dealSound', '{% static "pixel-tarot/assets/sounds/GP_Draw_3.wav" %}');
            this.load.audio('revealSound', '{% static "pixel-tarot/assets/sounds/GP_Draw_2.wav" %}');
        }

        // Card positions and game logic
        function create() {
            createStartScreen.call(this);
        }

        // Main menu screen
        function createStartScreen() {
            const startBackground = this.add.image(config.width/2, config.height/2, 'mainmenu')
                .setDisplaySize(config.width, config.height);

            createStartButton.call(this, () => {
                startBackground.destroy();
                createQuestionScreen.call(this);
            });
        }

        // Start button
        function createStartButton(onClick) {
            const buttonConfig = {
                width: 160,
                height: 50,
                x: config.width/2 - 80,
                y: config.height * 0.55
            };

            const background = this.add.graphics()
                .fillStyle(0x000000, 0.6)
                .lineStyle(2, 0xffd700, 1)
                .fillRoundedRect(buttonConfig.x, buttonConfig.y, buttonConfig.width, buttonConfig.height, 8)
                .strokeRoundedRect(buttonConfig.x, buttonConfig.y, buttonConfig.width, buttonConfig.height, 8);

            const button = this.add.text(config.width/2, buttonConfig.y + buttonConfig.height/2, 'Start Reading', {
                fontFamily: 'W95FA',
                fontSize: '24px',
                color: '#ffd700',
                padding: { x: 20, y: 10 }
            })
            .setOrigin(0.5, 0.5)
            .setShadow(2, 2, 'rgba(0,0,0,0.8)', 2)
            .setInteractive({ useHandCursor: true });

            // Hover effects
            button.on('pointerover', () => {
                background.clear()
                    .fillStyle(0x000000, 0.8)
                    .lineStyle(2, 0xfff700, 1)
                    .fillRoundedRect(buttonConfig.x, buttonConfig.y, buttonConfig.width, buttonConfig.height, 8)
                    .strokeRoundedRect(buttonConfig.x, buttonConfig.y, buttonConfig.width, buttonConfig.height, 8);
                button.setColor('#fff700');
            });

            button.on('pointerout', () => {
                background.clear()
                    .fillStyle(0x000000, 0.6)
                    .lineStyle(2, 0xffd700, 1)
                    .fillRoundedRect(buttonConfig.x, buttonConfig.y, buttonConfig.width, buttonConfig.height, 8)
                    .strokeRoundedRect(buttonConfig.x, buttonConfig.y, buttonConfig.width, buttonConfig.height, 8);
                button.setColor('#ffd700');
            });

            button.on('pointerdown', () => {
                background.destroy();
                button.destroy();
                onClick();
            });
        }

        function getRandomPosition(width, height) {
            // Random position outside the visible area
            const side = Math.floor(Math.random() * 4); // 0: top, 1: right, 2: bottom, 3: left
            let x, y;
            
            switch(side) {
                case 0: // top
                    x = Math.random() * width;
                    y = -200;
                    break;
                case 1: // right
                    x = width + 200;
                    y = Math.random() * height;
                    break;
                case 2: // bottom
                    x = Math.random() * width;
                    y = height + 200;
                    break;
                case 3: // left
                    x = -200;
                    y = Math.random() * height;
                    break;
            }
            return { x, y };
        }

        function createQuestionScreen() {
            // Create question screen with background
            const questionBackground = this.add.image(config.width/2, config.height/2, 'background-2')
                .setDisplaySize(config.width, config.height);

            // Add semi-transparent overlay
            const overlay = this.add.graphics();
            overlay.fillStyle(0x000000, 0.6);
            overlay.fillRect(0, 0, config.width, config.height);

            // Upper container for title and disclaimer
            const upperContainer = this.add.container(config.width/2, 120);

            // Add decorative line
            const line = this.add.graphics();
            line.lineStyle(2, 0xffd700, 0.8);
            line.beginPath();
            line.moveTo(-150, 60);
            line.lineTo(150, 60);
            line.strokePath();
            upperContainer.add(line);

            // Title text
            const titleText = this.add.text(0, 0, 'Ask the Cards', {
                fontFamily: 'W95FA',
                fontSize: '36px',
                color: '#ffd700',
                align: 'center'
            })
            .setShadow(0, 2, '#000000', 10, true, true);
            titleText.setOrigin(0.5);
            upperContainer.add(titleText);

            // Subtitle
            const subtitle = this.add.text(0, 80, 'What guidance do you seek?', {
                fontFamily: 'W95FA',
                fontSize: '24px',
                color: '#ffffff',
                align: 'center'
            })
            .setShadow(0, 2, '#000000', 5, true, true);
            subtitle.setOrigin(0.5);
            upperContainer.add(subtitle);

            // Disclaimer
            const disclaimer = this.add.text(0, 130, 'Frame your question thoughtfully.\nBe specific but avoid yes/no questions.\nFocus on guidance and insight.', {
                fontFamily: 'W95FA',
                fontSize: '16px',
                color: '#d3d3d3',
                align: 'center',
                lineSpacing: 10
            });
            disclaimer.setOrigin(0.5);
            upperContainer.add(disclaimer);

            // Lower container - moved higher up for mobile
            const lowerContainer = this.add.container(config.width/2, config.height - 250);

            // Text input with responsive width and positioning
            const textInput = document.createElement('textarea');
            textInput.maxLength = 200;
            const inputWidth = Math.min(300, window.innerWidth * 0.85);
            const inputHeight = Math.min(120, window.innerHeight * 0.15);
            textInput.style = `
                width: ${inputWidth}px; 
                height: ${inputHeight}px; 
                padding: 15px; 
                background: rgba(0,0,0,0.7); 
                color: white; 
                border: 2px solid #ffd700; 
                border-radius: 12px; 
                font-family: W95FA; 
                font-size: 16px;
                resize: none;
                outline: none;
                transition: all 0.3s ease;
                box-shadow: 0 0 10px rgba(0,0,0,0.5);
                margin-bottom: 20px;
            `;
            textInput.placeholder = 'Type your question here...';
            const isMobile = window.innerWidth < 768;

            // Adjust container position based on screen size
            const updatePositions = () => {
                
                lowerContainer.setPosition(
                    config.width/2,
                    isMobile ? config.height - 300 : config.height - 250
                );
            };

            // Initial position update
            updatePositions();

            // Add resize listener
            window.addEventListener('resize', updatePositions);

            const inputElement = this.add.dom(0, 0, textInput);
            lowerContainer.add(inputElement);

            let charCounterX = isMobile ? inputWidth/2 + 50 : inputWidth/2;
            let charCounterY = isMobile ? inputHeight/2 + 100 : inputHeight/2 - 50;

            // Character counter - adjusted position
            const charCounter = this.add.text(charCounterX, charCounterY, '0/200', {
                fontFamily: 'W95FA',
                fontSize: '14px',
                color: '#a0a0a0'
            });
            charCounter.setOrigin(1, 0.5);
            lowerContainer.add(charCounter);

            textInput.addEventListener('input', () => {
                charCounter.setText(`${textInput.value.length}/200`);
                // Change color based on length
                if (textInput.value.length > 150) {
                    charCounter.setColor('#ffa500');
                } else {
                    charCounter.setColor('#a0a0a0');
                }
            });

            // Consult button - adjusted position
            const consultButton = this.add.text(0, inputHeight + 60, 'Consult the Cards', {
                fontFamily: 'W95FA',
                fontSize: '24px',
                color: '#ffd700',
                padding: { x: 20, y: 12 }
            });
            consultButton.setOrigin(0.5);
            consultButton.setInteractive({ useHandCursor: true });

            // Button background - adjusted position
            const buttonBg = this.add.graphics();
            const buttonWidth = Math.min(220, inputWidth * 0.8);
            const buttonHeight = 50;
            const drawButtonBackground = (color, alpha) => {
                buttonBg.clear();
                buttonBg.fillStyle(0x000000, 0.6);
                buttonBg.lineStyle(2, color, alpha);
                buttonBg.fillRoundedRect(-buttonWidth/2, inputHeight + 40, buttonWidth, buttonHeight, 12);
                buttonBg.strokeRoundedRect(-buttonWidth/2, inputHeight + 40, buttonWidth, buttonHeight, 12);
            };
            
            drawButtonBackground(0xffd700, 1);
            lowerContainer.add(buttonBg);
            lowerContainer.add(consultButton);

            // Error message - adjusted position
            consultButton.on('pointerdown', () => {
                const tarotQuestion = textInput.value.trim();
                if (!tarotQuestion) {
                    const errorText = this.add.text(0, inputHeight + 110, 'Please enter your question first', {
                        fontFamily: 'W95FA',
                        fontSize: '16px',
                        color: '#ff6b6b'
                    }).setOrigin(0.5);
                    lowerContainer.add(errorText);
                    this.time.delayedCall(2000, () => errorText.destroy());
                    return;
                }

                // Store question for later use
                this.tarotQuestion = tarotQuestion;

                // Clean up question screen
                questionBackground.destroy();
                overlay.destroy();
                upperContainer.destroy();
                lowerContainer.destroy();

                // Add game background and continue with card dealing
                const background = this.add.image(config.width/2, config.height/2, 'background');
                background.setDisplaySize(config.width, config.height);

                // Add refresh button
                const refreshButton = this.add.image(config.width - 35, 35, 'refresh');
                refreshButton.setDisplaySize(55, 55);
                refreshButton.setInteractive({ 
                    hitArea: new Phaser.Geom.Circle(27.5, 27.5, 35),
                    hitAreaCallback: Phaser.Geom.Circle.Contains,
                    useHandCursor: true 
                });
                refreshButton.on('pointerover', function() {
                    this.setScale(1.1);
                });
                refreshButton.on('pointerout', function() {
                    this.setScale(1);
                });
                refreshButton.on('pointerdown', function() {
                    location.reload();
                });

                // Create interpret button (initially hidden)
                const buttonWidth = 120;
                const buttonHeight = 40;
                const buttonX = 50;
                const buttonY = config.height - 50;

                const buttonBackground = this.add.graphics();
                buttonBackground.fillStyle(0x808080, 0.6);
                buttonBackground.lineStyle(2, 0x808080, 1);
                buttonBackground.fillRoundedRect(buttonX, buttonY - buttonHeight, buttonWidth, buttonHeight, 8);
                buttonBackground.strokeRoundedRect(buttonX, buttonY - buttonHeight, buttonWidth, buttonHeight, 8);
                buttonBackground.setVisible(false);

                const interpretButton = this.add.text(buttonX + buttonWidth/2, buttonY - buttonHeight/2, 'Interpret', {
                    fontFamily: 'W95FA',
                    fontSize: '20px',
                    color: '#d3d3d3',
                    padding: { x: 20, y: 10 }
                });
                interpretButton.setOrigin(0.5, 0.5);
                interpretButton.setVisible(false);
                interpretButton.setShadow(1, 1, 'rgba(0,0,0,0.8)', 1);
                interpretButton.setInteractive({ useHandCursor: true });

                // Create sound objects
                const dealSound = this.sound.add('dealSound', { volume: 0.5 });
                const revealSound = this.sound.add('revealSound', { volume: 0.5 });
                
                // Configure sounds
                dealSound.setRate(1.0);
                revealSound.setRate(1.0);
                
                const cards = [
                    {% for card in cards %}
                    {
                        name: '{{ card.name }}',
                        isReversed: {{ card.is_reversed|lower }}
                    },
                    {% endfor %}
                ];

                const scale = 1.0;
                const cardWidth = 100 * scale;
                const cardHeight = 160 * scale;
                const spacing = 15 * scale;
                const centerX = (config.width / 2) - cardWidth;
                const centerY = config.height / 2;

                // Celtic Cross positions
                const positions = [
                    { x: centerX, y: centerY, title: "The Present", angle: 0 },
                    { x: centerX, y: centerY, title: "The Challenge", angle: 90 },
                    { x: centerX, y: centerY + cardHeight + spacing, title: "The Foundation", angle: 0 },
                    { x: centerX - cardWidth - spacing, y: centerY, title: "The Past", angle: 0 },
                    { x: centerX + cardWidth + spacing, y: centerY, title: "The Future", angle: 0 },
                    { x: centerX + cardWidth * 2 + spacing * 2, y: centerY + cardHeight * 1.5 + spacing, title: "Your Influence", angle: 0 },
                    { x: centerX + cardWidth * 2 + spacing * 2, y: centerY + cardHeight/2, title: "External Forces", angle: 0 },
                    { x: centerX + cardWidth * 2 + spacing * 2, y: centerY - cardHeight/2, title: "Hopes and Fears", angle: 0 },
                    { x: centerX, y: centerY - cardHeight - spacing, title: "Environment", angle: 0 },
                    { x: centerX + cardWidth * 2 + spacing * 2, y: centerY - cardHeight * 1.5 - spacing, title: "The Outcome", angle: 0 }
                ];

                // Place cards with animation
                let placedCards = [];
                
                // Create placement order array
                const cardOrder = [0, 1, 2, 3, 4, 8, 5, 6, 7, 9];
                
                cardOrder.forEach((cardIndex, index) => {
                    const pos = positions[cardIndex];
                    const cardData = cards[cardIndex];
                    const startPos = getRandomPosition(config.width, config.height);
                    
                    // Create card back first
                    const card = this.add.image(startPos.x, startPos.y, 'card_back');
                    card.setDisplaySize(cardWidth, cardHeight);
                    card.setAngle(pos.angle);
                    card.setAlpha(0);

                    card.frontImage = cardData.name;
                    card.isReversed = cardData.isReversed;
                    placedCards[cardIndex] = card;

                    this.time.delayedCall(index * 500, () => {
                        dealSound.play();
                        card.setAlpha(1);
                        this.tweens.add({
                            targets: card,
                            x: pos.x,
                            y: pos.y,
                            ease: 'Power2',
                            duration: 500,
                            onComplete: () => {
                                if (index === cards.length - 1) {
                                    this.time.delayedCall(1000, () => {
                                        cardOrder.forEach((revealIndex, i) => {
                                            this.time.delayedCall(i * 500, () => {
                                                const placedCard = placedCards[revealIndex];
                                                revealSound.play();
                                                this.tweens.add({
                                                    targets: placedCard,
                                                    scaleX: 0,
                                                    duration: 250,
                                                    ease: 'Linear',
                                                    onComplete: () => {
                                                        placedCard.setTexture(placedCard.frontImage);
                                                        placedCard.setDisplaySize(cardWidth, cardHeight);
                                                        if (placedCard.isReversed) {
                                                            placedCard.setAngle(placedCard.angle + 180);
                                                        }
                                                        this.tweens.add({
                                                            targets: placedCard,
                                                            scaleX: 1,
                                                            duration: 250,
                                                            ease: 'Linear',
                                                            onComplete: () => {
                                                                placedCard.setInteractive();
                                                                placedCard.setDisplaySize(cardWidth, cardHeight);
                                                                
                                                                placedCard.on('pointerover', function() {
                                                                    this.setTint(0xdddddd);
                                                                    const text = this.scene.add.text(this.x, this.y + cardHeight/2 + 10, positions[revealIndex].title, {
                                                                        fontSize: '14px',
                                                                        fill: '#fff',
                                                                        backgroundColor: '#000'
                                                                    });
                                                                    text.setOrigin(0.5);
                                                                    this.positionText = text;
                                                                });
                                                                
                                                                placedCard.on('pointerout', function() {
                                                                    this.clearTint();
                                                                    if (this.positionText) {
                                                                        this.positionText.destroy();
                                                                    }
                                                                });

                                                                if (revealIndex === cardOrder[cardOrder.length - 1]) {
                                                                    this.time.delayedCall(500, () => {
                                                                        buttonBackground.setVisible(true);
                                                                        interpretButton.setVisible(true);
                                                                    });
                                                                }
                                                            }
                                                        });
                                                    }
                                                });
                                            });
                                        });
                                    });
                                }
                            }
                        });
                    });
                });
            });
        }
    </script>
</head>
<body>
    <div class="header-banner">
        <div class="container text-center py-2 position-relative">
            <a href="/" class="back-button">
                <i class="fas fa-arrow-left"></i>
                <span>Back</span>
            </a>
            <img src="{% static 'img/logo.png' %}" alt="Profile" class="profile-image rounded-circle">
            <h1 class="mt-2 mb-1 text-white"><span class="josefin-sans-txt">A. TEOMAN</span> <span class="highlight quicksand-txt">UNAY</span></h1>
            <h2 class="text-white quicksand-txt mb-1">Software Engineer</h2>
        </div>
    </div>
    <div id="game-container">
    <div id="game"></div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html> 